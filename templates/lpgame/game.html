{% extends 'base.html' %}
{% block head %}
    <link href="{{ STATIC_URL }}game.css" rel="stylesheet">
{% endblock %}
{% block content %}
{% load url from future %}
<div class="container">
    <div class="nanana">
    {% for letters in rows %}
        <div class="row-fluid show-grid">
        {% for entry in letters %}
            <a href="#" class="letter">
            {% if entry.gamer %}
                {% if entry.gamer == user_id %}
                    <div class="span1 user1" id="letter_{{ entry.letter_id }}">
                {% else %}
                    <div class="span1 user2" id="letter_{{ entry.letter_id }}">
                {% endif %}
            {% else %}
                <div class="span1" id="letter_{{ entry.letter_id }}">
            {% endif %}
                    {{ entry.letter }}
                </div>
            </a>
        {% endfor %}
        </div>
    {% endfor %}
    </div>
    <div class="selected">
    </div>
    <input type="button" id="submit" value="Submit" class="btn"/>
</div>
<script type="text/javascript">
$(document).ready(function (){
    var selected = [];
    var token = "{{ csrf_token }}";
    var session_id = "{{ session_id }}"
    $("a.letter").click(function(){
        var $this = $(this);
        var div = $this.children();
        var let_id = div.attr('id').split('_')[1];
        if (selected.indexOf(let_id) == -1){
            selected.push(let_id);
            $(div).addClass('checked');
            console.log(selected);
        }
    });
    $('input#submit').click(function(){
        $.ajax({
            type: "POST",
            url: "/game/make_turn/",
            cache: false,
            data: {
                'selected': selected,
                'csrfmiddlewaretoken': token,
                'session_id': session_id
            },
            dataType: "json"
        }).done(function(data){
            selected = [];
{#            $('a.letter').children().css({'background-color':'white'});#}
        })
    })
});
var sock = new SockJS('{{ async_url }}/sockjs');
sock.onopen = function() {
    console.log('open');
    send_session_id()
};
sock.onmessage = function(e) {
    console.log(e)
    var eventType = e.data.event;
    console.log(e.data)
    if (eventType == 'new_turn'){
        var eventLetters = JSON.parse(e.data.data);
        var eventUser = e.data.user;
        eventLetters.forEach(function(l_id){
            console.log(l_id);
            var user = null;
            if (eventUser == {{ user_id }}){
                user = 'user1';
            }
            else{
                user = 'user2';
            }
            $('a.letter #letter_'+l_id).addClass(user);
        })
    }
};
sock.onclose = function() {
    console.log('close');
};
function send_session_id() {
    sock.send(JSON.stringify({
        event: "init",
        session_id: "{{ session_id }}"
    }))
};
</script>
{% endblock %}