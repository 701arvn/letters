{% extends 'lpgame/game_base.html' %}
{% block subhead %}
    <link href="{{ STATIC_URL }}game.css" rel="stylesheet">
{% endblock %}
{% load i18n %}
{% load game_tags %}
{% block subcontent %}
<div class="game-container">
    <div class="alert alert-info" id="game_info" style="display: none;"></div>
    <div class="alert alert-success" id="turn_info" style="display: none;">{% trans "Waiting for other player's turn" %}</div>
    <div class="game-field">
        <div class="game_score">{% current_score %}</div>
        <div class="letters-space">
        {% for letters in rows %}
            <div class="row-fluid show-grid">
            {% for entry in letters %}
                <a href="#" class="letter">
                {% if entry.gamer %}
                    {% if entry.gamer == user_id %}
                        <div class="span1 user1" id="letter_{{ entry.letter_id }}">
                    {% else %}
                        <div class="span1 user2" id="letter_{{ entry.letter_id }}">
                    {% endif %}
                {% else %}
                    <div class="span1" id="letter_{{ entry.letter_id }}">
                {% endif %}
                        {{ entry.letter }}
                    </div>
                </a>
            {% endfor %}
            </div>
        {% endfor %}
        </div>
        <div class="selected row-fluid show-grid">
        </div>
        <br/>
        <input type="button" id="submit" value="{% trans 'Submit' %}" class="btn"/>
        <input type="button" id="end_game" value="{% trans 'End game' %}" class="btn"/>
        <input type="button" id="reset_selected" value="{% trans 'Reset selected' %}" class="btn" style="display: none;"/>
    </div>
</div>
<script type="text/javascript">
var selected = [];
var token = "{{ csrf_token }}";
var session_id = "{{ session_id }}";
var current_player = "{{ is_current_player }}" === "True";
var game_ready = "{{ ready }}" === "True";
$(document).ready(function (){
    if (!current_player || !game_ready){
        $('#submit').prop('disabled', true)
        if (!current_player) $("#turn_info").show();
    }
    $("a.letter").click(function(){
        var $this = $(this);
        var div = $($this.children());
        var let_id = div.attr('id').split('_')[1];
        if (div.hasClass('checked')){
            var index = selected.indexOf(let_id);
            selected.splice(index, 1); 
            div.removeClass('checked');
            show_word();
            if (!selected.length){
                $('#reset_selected').hide()
            }
            return false;
        }
        if (selected.indexOf(let_id) == -1){
            selected.push(let_id);
            div.addClass('checked');
            show_word();
            $('#reset_selected').show()
        }
    });
    $('input#submit').click(function(){
        $.ajax({
            type: "POST",
            url: "/game/make_turn/",
            cache: false,
            data: {
                'selected': selected,
                'csrfmiddlewaretoken': token,
                'session_id': session_id
            },
            dataType: "json"
        }).done(function(data){
            if (data.success){
                selected = [];
                $('div.selected').html('');
                $('div.checked').removeClass('checked');
                $('#reset_selected').hide();
                $('#submit').prop('disabled', true);
                $("#turn_info").show();
            }
            else{
                alert(data.error)
            }
        }).fail(function(data){
            alert('Some server error');
    })
    })
    $('input#end_game').click(function(){
            $.ajax({
                type: "POST",
                url: "/game/end_game/",
                cache: false,
                data: {
                    'csrfmiddlewaretoken': token,
                    'session_id': session_id
                },
                dataType: "json"
            })
    });
    $('input#reset_selected').click(function(){
        selected = [];
        $('div.checked').removeClass('checked');
        show_word();
    })
    new_connection();
});
function show_word() {
    $('div.selected').html('')
    selected.forEach(function(l_id){
        $('div.selected').append($("#letter_"+l_id).html().trim())
    })
}
function get_player_name(user_id){
    if (user_id == {{ user_id }}){
        return $('#name_user1').html();
    }
    else{
        return $('#name_user2').html();
    }
}
function show_info(user, data){
    var username = get_player_name(user);
    var text = username + " {% trans 'played word'%} " + data.word;
    var info_div = $('#game_info');
    info_div.html(text);
    info_div.show('slow');
    setTimeout("$('#game_info').hide('slow')", 20000);

}
function new_connection(){
    var sock = new SockJS('{{ async_url }}/sockjs');
    sock.onopen = function() {
        {% if debug %}
            console.log('open');
        {% endif %}
        send_session_id()
    };
    sock.onmessage = function(e) {
        var eventType = e.data.event;
        {% if debug %}
            console.log(e.data);
        {% endif %}
        if (eventType == 'new_turn'){
            var eventData = JSON.parse(e.data.data);
            var eventUser = e.data.user;
            eventData.letters.forEach(function(l_id){
                var user = null;
                if (eventUser == {{ user_id }}){
                    user = 'user1';
                    prev = 'user2';
                }
                else{
                    user = 'user2';
                    prev = 'user1';
                }
                $('a.letter #letter_'+l_id).removeClass(prev);
                $('a.letter #letter_'+l_id).addClass(user);
            })
            for (user in eventData.score){
                if (user == {{ user_id }}){
                    $('#score_user1').html(eventData.score[user]);
                }
                else{
                    $('#score_user2').html(eventData.score[user]);
                }
            }
            if (eventUser != {{ user_id }}){
                show_info(eventUser, eventData);
                $('#submit').prop('disabled', false)
                $("#turn_info").hide();
            }
        }
        else if (eventType == 'game_ready'){
            $('#submit').prop('disabled', false)
        }
    };
    sock.onclose = function() {
        {% if debug %}
            console.log('closed');
        {% endif %}
        setTimeout('new_connection()', 5000);
        //TODO get latest data
    };
    function send_session_id() {
        sock.send(JSON.stringify({
            event: "init",
            session_id: "{{ session_id }}"
        }))
    }
}
</script>
{% endblock %}
